<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 3.2//EN">
<html>
  <head>
    <title></title>
    <script src="/public/js/underscore-min.js"></script>
    
    <script src="/public/js/jquery-3.1.1.min.js"></script>
    <script src="/public/js/tether.min.js"></script>

    <script src="/public/bootstrap/js/bootstrap.min.js"></script>
    <link href="/public/bootstrap/css/bootstrap.min.css" media="screen" rel="stylesheet" type="text/css">
    <link  href="/public/bootstrap/css/submenu.css" media="screen" rel="stylesheet" type="text/css">
    
    <script src="/public/three/js/three.min.js"></script>
    <script src="/public/three/js/OBJLoader.js"></script>
    <script src="/public/three/js/FBXLoader.js"></script>
    <script src="/public/three/js/Projector.js"></script>
    <script src="/public/three/js/SVGRenderer.js"></script>
    <script src="/public/three/js/CanvasRenderer.js"></script>
    

    <script src="/public/app/iro.js"></script>
    <script src="/public/app/iro.obj.js"></script>
    <script src="/public/app/iro.renderer.js"></script>
    
    
    <style>
      td.x, td.y, td.z { text-align: right; width: 5em }
      body {
         min-height: 2000px;
         padding-top: 0px;
      }
      #c {
	  position: fixed;
	  left: 0px;
	  width: 100%;
	  height: 100%;
	  border: solid thin red;
      }
      .renderer {  border: solid thin grey }
    </style>
  </head>
  <body>
    <div id="c"></div>
    %= include 'layouts/menu'
    <div class="container-fluid" style="padding-top: 70px; z-index: 1;">
    % for (0..1) {
      <div class="col-md-6 col-md-offset-0" >
	<div class="dropzone jumbotron" style="width:100%;height:80vh;">
	  drop your OBJ file here
	</div>
	<div class="renderer" style="width:100%;height:80vh;">
	</div>
      </div>
      % }
    </div>
  </body>
  <script>
    var i = new Iro;

var lights = [
    { offset: { x: 0, y: 0, z: 70 },    shadowDarkness: 0, color: 0x777777 },
    { offset: { x: -70, y:  0, z:  0 }, shadowDarkness: 0, color: 0x777777 },
    { offset: { x:   0, y: 70, z:  0 }, shadowDarkness: 0, color: 0x777777 },
    { offset: { x: -50, y: 40, z: 70 }, shadowDarkness: 0, color: 0x777777 }
];

var scenes = [];
var renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true, preserveDrawingBuffer: true });
renderer.setPixelRatio( window.devicePixelRatio );

function animate() {
    render();
    requestAnimationFrame( animate );
}

function render(){
    console.log(scenes.length)

    renderer.setClearColor( 0xffffff );
    renderer.setScissorTest( false );
    renderer.clear();
    renderer.setClearColor( 0xe0e0e0 );
    renderer.setScissorTest( true );    

    scenes.forEach( function( scene ) {
	scene.render();
    });
}

$(function(){
    $('.renderer').hide();
    var e = $('#c');
    renderer.setSize( $(e).width(), $(e).height() );
    
    e.empty();
    e.append( renderer.domElement );

    console.log(renderer);
    animate();

    $('.dropzone').each(function(i, e){
	console.log(i);
	console.log(e);

	var r = new Iro.scene($(e).siblings('.renderer').first(), renderer);
	
	r.init();
	r.addLights(lights);
	r.addCamera({ x: 0, y: 0, z: 70 });
	r.offsets = { x: 0, y: 70, z: 0 };
	r.showAxes();
	// r.animate();
	
	$(this).get(0).addEventListener('dragover', function(e) {
    	    e.stopPropagation();
    	    e.preventDefault();
    	    e.dataTransfer.dropEffect = 'copy';
	});

	$(this).get(0).addEventListener('drop', function(e) {
	    e.stopPropagation();
	    e.preventDefault();
	    console.log('drop');
	    file = e.dataTransfer.files[0]; // Array of all files
	    var reader = new FileReader();
            reader.onload = function(e2) { // finished reading file data.
		src = e2.target.result;
		console.log(src.length);

		var o = new Iro.object;
		o.setObject(src)
		r.addObject(o);
		
		$(e.target).siblings('.renderer').show();
		$(e.target).hide();
		r.render();
		r.fitObject();
		r.render();
		scenes.push(r)
            }
            reader.readAsText(file);
	})
    });
})

</script>
    
</html>
